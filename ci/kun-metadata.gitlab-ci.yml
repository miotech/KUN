
# workflow:
#   rules:
#     - changes:
#       - kun-metadata/*

verify-test:
  stage: verify
  image: gradle:6.5.0-jdk8
  except:
    - master
    - release
    - production
    - tags
  allow_failure: false
  script:
    - ./gradlew test -p kun-metadata
    - ./gradlew check -p kun-metadata
    - ./gradlew codeCoverageReport -p kun-metadata
  only:
    changes:
      - ./kun-metadata/*

verify-sonar:
  stage: verify
  image: mioyingtech/gradle-sonar:0.1-build
  except:
    - release
    - production
    - tags
  allow_failure: false
  script:
    - >
      if [ $CI_COMMIT_REF_NAME ="master" ]; then 
          ./gradlew sonarqube -p kun-metadata -Dsonar.host.url=$SONAR_HOST -Dsonar.login=$SONAR_TOKEN -Dsonar.analysis.mode=publish -Dsonar.issuesReport.html.enable=true -Dsonar.gitlab.project_id=$CI_PROJECT_ID -Dsonar.gitlab.ref_name=$CI_COMMIT_REF_NAME -Dsonar.gitlab.commit_sha=$CI_COMMIT_SHA -Dsonar.projectKey=com.miotech:kun-metadata -Dsonar.projectName='kun-metadata' -Dsonar.sources=./kun-metadata/src/main -Dsonar.sourceEncoding=UTF-8 -Dsonar.java.binaries=./kun-metadata/build
      else ./gradlew sonarqube -p kun-metadata -Dsonar.host.url=$SONAR_HOST -Dsonar.login=$SONAR_TOKEN -Dsonar.analysis.mode=preview -Dsonar.issuesReport.html.enable=true -Dsonar.gitlab.project_id=$CI_PROJECT_ID -Dsonar.gitlab.ref_name=$CI_COMMIT_REF_NAME -Dsonar.gitlab.commit_sha=$CI_COMMIT_SHA -Dsonar.projectKey=com.miotech:kun-metadata -Dsonar.projectName='kun-metadata' -Dsonar.sources=./kun-metadata/src/main -Dsonar.sourceEncoding=UTF-8 -Dsonar.java.binaries=./kun-metadata/build  
      fi
  only:
    changes:
      - ./kun-metadata/*

.build_job:
  stage: build-images
  script:
    - ./gradlew :kun-metadata:shadowJar
    - mkdir -p /builds/artifacts/kun-metadata/${CI_COMMIT_REF_NAME}/
    - cp kun-metadata/build/libs/*.jar /builds/artifacts/kun-metadata/${CI_COMMIT_REF_NAME}/
  only:
    refs:
      - master
      - release
      - tags
    changes:
      - ./kun-metadata/*

docker build:
  extends: .build_job
  image: gradle:6.5.0-jdk8
  tags:
    - docker-push
  script:
    - mkdir -p build/libs/
    - rsync -vzrtopg --progress -e ssh root@$CI_RUNNER_SERVER:/miotech/artifacts/kun-metadata/${CI_COMMIT_REF_NAME}/ build/libs/
    - export TAG_METADATA=$CI_COMMIT_REF_NAME
    - ./gradlew :kun-metadata:buildPushImage