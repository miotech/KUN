plugins {
  id "com.github.node-gradle.node" version "2.2.4"
  id "org.sonarqube" version "2.7"
}

node {
    version = "12.13.0"
    yarnVersion = "1.9.4"
    download = true
}

task execTask(type: Exec) {
	workingDir './'
  def commands = []
  if (System.getProperty("os.name").toLowerCase().startsWith("windows")) {
    commands << 'cmd'
    commands << '/c'
    commands << 'yarn install'
  } else {
    commands << 'bash'
    commands << '-c'
    commands << 'yarn install'
  }
  commandLine = commands
}

//调用yarn run build命令的Gradle任务
task yarnBuild(type: YarnTask, dependsOn: [execTask, yarn]) {
  group = 'node'
  args = ['run', 'build']
}

apply plugin: "com.bmuschko.docker-remote-api"
import com.bmuschko.gradle.docker.tasks.image.DockerBuildImage
task buildDockerImage(type: DockerBuildImage) {
    inputDir = file('.')
    images.add(System.getenv("DOCKER_URL")+'mioyingtech/'+'kun-data-discovery-frontend'+':'+System.getenv("TAG_DATA_DISCOVERY_FRONTEND"))
    
}
docker {
     registryCredentials {
      url = System.getenv("DOCKER_URL")
        username = System.getenv("DOCKER_USER")
        password = System.getenv("DOCKER_PASS")
     }
 } 
import com.bmuschko.gradle.docker.tasks.image.DockerPushImage
task buildPushImage(type: DockerPushImage) {
    dependsOn buildDockerImage
    images.add(System.getenv("DOCKER_URL")+'mioyingtech/'+'kun-data-discovery-frontend'+':'+System.getenv("TAG_DATA_DISCOVERY_FRONTEND"))
    
}

apply plugin: "org.sonarqube"